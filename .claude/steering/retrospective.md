# Spec Retrospective

**Last Updated**: 2026-02-15
**Defect Specs Analyzed**: 13
**Learnings Generated**: 12

---

## How to Use This Document

This document is automatically generated by `/running-retrospectives` and read by
`/writing-specs` during Phase 1 (SPECIFY). When writing new feature specs, consult
the relevant sections below to avoid repeating past spec gaps.

---

## Missing Acceptance Criteria

Defects caused by scenarios that the original feature spec did not cover at all.

| Learning | Source Defect | Related Feature Spec | Recommendation |
|----------|--------------|---------------------|----------------|
| Feature spec for Chrome launch did not include an AC for passing `--enable-automation` flag, which Chrome expects during CDP-controlled sessions to display the automation infobar | `.claude/specs/70-fix-enable-automation-flag/` | `.claude/specs/5-chrome-instance-discovery-and-launch/` | When specifying browser launch features, include ACs for all standard automation flags that browsers expect (e.g., `--enable-automation`, `--disable-popup-blocking`). Enumerate the minimal set of flags required for a well-behaved automation session. |
| Feature spec for `perf vitals` had no AC for when metrics cannot be collected — missing metrics were silently omitted from JSON output instead of appearing as `null`, and no non-zero exit code was specified | `.claude/specs/75-fix-perf-vitals-missing-metrics/` | `.claude/specs/22-performance-tracing/` | When specifying commands that produce structured output with optional fields, always include ACs for: (1) how absent/uncollectable values are serialized (null vs omission), (2) whether all expected fields must always be present in the output schema, and (3) what exit code to use when expected data cannot be collected. |
| Feature spec for session management did not include an AC for preserving the Chrome PID when reconnecting to the same instance via auto-discover after an initial `--launch` | `.claude/specs/87-fix-connect-auto-discover-overwrites-session-pid/` | `.claude/specs/6-session-and-connection-management/` | When specifying session/state file management, include ACs for the "reconnect to same instance" scenario. Specifically: if a prior session exists with richer metadata (e.g., PID from launch), reconnecting to the same endpoint should preserve that metadata rather than overwriting it with defaults. |

---

## Undertested Boundaries

Defects caused by boundary conditions the original feature spec addressed
insufficiently.

| Learning | Source Defect | Related Feature Spec | Recommendation |
|----------|--------------|---------------------|----------------|
| Feature spec for `navigate back`/`forward` tested same-origin history navigation but not cross-origin navigation, which uses different CDP event semantics and times out | `.claude/specs/72-fix-navigate-back-forward-cross-origin-timeout/` | `.claude/specs/8-url-navigation/` | When specifying browser history navigation (back/forward), always include ACs for cross-origin navigation scenarios. Cross-origin navigations may trigger different browser-level events (e.g., frame detach/reattach) compared to same-origin navigations. Include at least one AC where back/forward crosses domain boundaries. |
| Feature spec for accessibility tree snapshot tested simple/static pages but not complex dynamically-rendered pages where Chrome's `getFullAXTree` returns nodes with empty `childIds`, producing an empty tree | `.claude/specs/73-fix-page-snapshot-empty-accessibility-tree/` | `.claude/specs/10-accessibility-tree-snapshot/` | When specifying features that depend on CDP data structures (like accessibility trees), include ACs for both simple/static content and complex/dynamic real-world content. CDP responses can have significantly different structures for complex pages — test against at least one real-world site (e.g., google.com) in addition to simple test pages. |
| Feature spec for accessibility tree snapshot specified "excluded ignored/invisible nodes" (FR12) but did not specify what happens to the children of ignored nodes — they were silently dropped instead of being promoted to the nearest visible ancestor | `.claude/specs/83-fix-snapshot-ignored-nodes/` | `.claude/specs/10-accessibility-tree-snapshot/` | When specifying tree-filtering behavior (e.g., "exclude ignored nodes"), always include ACs for how descendants of filtered nodes are handled. Specify whether children should be: (a) dropped along with the filtered parent, (b) promoted/reparented to the nearest non-filtered ancestor, or (c) handled differently. Include an AC with nested ignored nodes to test multi-level promotion. |

---

## Domain-Specific Gaps

Defects caused by domain knowledge the original feature spec failed to capture.

| Learning | Source Defect | Related Feature Spec | Recommendation |
|----------|--------------|---------------------|----------------|
| Feature spec did not capture that Chrome's DevTools HTTP server sends complete responses with `Content-Length` but delays closing TCP connections, causing `read_to_string()` to block until timeout | `.claude/specs/68-fix-connect-launch-timeout/` | `.claude/specs/6-session-and-connection-management/` | When specifying HTTP communication with Chrome's DevTools endpoints, include requirements for Content-Length-aware response reading rather than EOF-based reading. Chrome's HTTP server behavior varies across platforms regarding connection close timing. |
| Feature spec for `emulate status` did not account for CDP session isolation — each CLI invocation creates a new session, so `emulate status` cannot query Chrome for overrides set by a previous `emulate set` invocation | `.claude/specs/74-fix-emulate-status-inaccurate-state/` | `.claude/specs/21-device-network-viewport-emulation/` | When specifying features where state is set in one CLI invocation and queried in another, always include requirements for how state persists across invocations. CDP sessions are ephemeral (per-connection), so any state that must survive across commands needs an explicit persistence mechanism (e.g., state file). Include ACs that test the set-then-query-in-separate-invocation workflow. |
| Feature spec for `perf start`/`perf stop` assumed tracing state persists between separate CLI invocations, but CDP tracing is session-scoped — a new session cannot stop a trace it didn't start | `.claude/specs/76-fix-perf-cross-invocation-state-loss/` | `.claude/specs/22-performance-tracing/` | When specifying multi-step workflows that span separate CLI invocations (e.g., start/stop), verify whether the underlying protocol maintains state across connections. CDP sessions are independent — tracing, breakpoints, and other session-scoped state do not persist. Prefer single-invocation designs (e.g., `perf record` with signal-based stop) over split start/stop patterns. |
| Feature spec for `tabs create --background` did not account for Chrome ignoring the `background: true` parameter in `Target.createTarget`, requiring explicit re-activation of the previously active tab as a workaround | `.claude/specs/82-fix-tabs-create-background/` | `.claude/specs/7-tab-management/` | When specifying features that depend on optional CDP parameters (like `background` in `Target.createTarget`), include a requirement to verify the parameter is honored and specify a fallback strategy if the browser ignores it. Not all CDP parameters are reliably implemented across Chrome versions. |
| Feature spec for emulation did not account for CDP session isolation causing all session-scoped overrides (user-agent, device scale, geolocation, color scheme) to be lost when the CLI command exits | `.claude/specs/85-fix-emulate-overrides-persistence/` | `.claude/specs/21-device-network-viewport-emulation/` | When specifying emulation/override features in a CLI that creates ephemeral CDP sessions, include explicit requirements for persisting overrides to a state file and re-applying them when new sessions are created. Include ACs that test the "set override in command A, verify it's active in command B" workflow. |
| Feature spec for dialog handling did not account for Chrome blocking `Page.enable` (and other CDP commands) when a JavaScript dialog is open — the exact scenario when dialog commands are needed | `.claude/specs/86-fix-dialog-commands-timeout-with-open-dialog/` | `.claude/specs/20-browser-dialog-handling/` | When specifying dialog handling features, include requirements for session setup behavior in the presence of an already-open dialog. Chrome pauses JavaScript execution and blocks certain CDP domain enablement commands when a dialog is open. Dialog commands must use a lightweight session setup that avoids blocked CDP calls. Include ACs where the dialog is already open before the command runs. |
