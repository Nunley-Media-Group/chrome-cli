# File: tests/features/form.feature
#
# Generated from: .claude/specs/16-form-input-and-filling/requirements.md
# Issue: #16

Feature: Form input and filling
  As a developer or automation engineer
  I want to fill form fields, select dropdown options, and clear inputs via the CLI
  So that my automation scripts can programmatically interact with web forms

  Background:
    Given Chrome is running with CDP enabled
    And a page is loaded with a form containing various field types

  # --- Happy Path: Single Field Fill ---

  Scenario: Fill a text input field by UID
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a text input with UID "s1"
    When I run "chrome-cli form fill s1 'John Doe'"
    Then the exit code should be 0
    And the output JSON "filled" should be "s1"
    And the output JSON "value" should be "John Doe"

  Scenario: Fill a text input field by CSS selector
    Given the page has a text input with id "email"
    When I run "chrome-cli form fill css:#email user@example.com"
    Then the exit code should be 0
    And the output JSON "filled" should be "css:#email"
    And the output JSON "value" should be "user@example.com"

  Scenario: Fill a select dropdown
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a select element with UID "s3" and options "option1", "option2", "option3"
    When I run "chrome-cli form fill s3 option2"
    Then the exit code should be 0
    And the output JSON "filled" should be "s3"
    And the output JSON "value" should be "option2"
    And the select element's selected option should be "option2"

  Scenario: Fill a textarea
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a textarea with UID "s4"
    When I run "chrome-cli form fill s4 'Multi-line text content'"
    Then the exit code should be 0
    And the output JSON "filled" should be "s4"
    And the output JSON "value" should be "Multi-line text content"

  Scenario: Toggle a checkbox to checked
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has an unchecked checkbox with UID "s5"
    When I run "chrome-cli form fill s5 true"
    Then the exit code should be 0
    And the output JSON "filled" should be "s5"
    And the output JSON "value" should be "true"
    And the checkbox should be checked

  Scenario: Toggle a checkbox to unchecked
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a checked checkbox with UID "s5"
    When I run "chrome-cli form fill s5 false"
    Then the exit code should be 0
    And the checkbox should be unchecked

  # --- Happy Path: Include Snapshot ---

  Scenario: Fill with --include-snapshot flag
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a text input with UID "s1"
    When I run "chrome-cli form fill s1 'Jane' --include-snapshot"
    Then the exit code should be 0
    And the output JSON "filled" should be "s1"
    And the output JSON "value" should be "Jane"
    And the output JSON should contain a "snapshot" object

  # --- Happy Path: Fill Many ---

  Scenario: Fill multiple fields at once from inline JSON
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has text inputs with UIDs "s1" and "s2"
    When I run "chrome-cli form fill-many '[{\"uid\":\"s1\",\"value\":\"John\"},{\"uid\":\"s2\",\"value\":\"Doe\"}]'"
    Then the exit code should be 0
    And the output should be a JSON array with 2 results
    And the first result "filled" should be "s1"
    And the first result "value" should be "John"
    And the second result "filled" should be "s2"
    And the second result "value" should be "Doe"

  Scenario: Fill multiple fields from a JSON file
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has text inputs with UIDs "s1" and "s2"
    And a JSON file "fields.json" contains '[{"uid":"s1","value":"John"},{"uid":"s2","value":"Doe"}]'
    When I run "chrome-cli form fill-many --file fields.json"
    Then the exit code should be 0
    And the output should be a JSON array with 2 results

  Scenario: Fill many with --include-snapshot flag
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has text inputs with UIDs "s1" and "s2"
    When I run "chrome-cli form fill-many '[{\"uid\":\"s1\",\"value\":\"John\"}]' --include-snapshot"
    Then the exit code should be 0
    And the output JSON should contain a "snapshot" object

  # --- Happy Path: Clear ---

  Scenario: Clear a form field
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a text input with UID "s1" containing value "old"
    When I run "chrome-cli form clear s1"
    Then the exit code should be 0
    And the output JSON "cleared" should be "s1"
    And the text input value should be empty

  # --- Framework Compatibility ---

  Scenario: Fill dispatches events for framework compatibility
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has a React-controlled input with UID "s1"
    And an event listener records dispatched events
    When I run "chrome-cli form fill s1 'test'"
    Then an "input" event should have been dispatched with bubbles true
    And a "change" event should have been dispatched with bubbles true

  # --- Tab Targeting ---

  Scenario: Fill with --tab flag targets specific tab
    Given multiple tabs are open
    And tab "TAB_ID" has a form with text input UID "s1"
    When I run "chrome-cli form fill s1 'value' --tab TAB_ID"
    Then the exit code should be 0
    And the field in the specified tab should be filled

  # --- Error Handling ---

  Scenario: Fill nonexistent UID returns error
    Given an accessibility snapshot has been taken with UIDs assigned
    When I run "chrome-cli form fill s999 'value'"
    Then the exit code should be nonzero
    And stderr should contain "UID not found"

  Scenario: Fill without required arguments
    When I run "chrome-cli form fill"
    Then the exit code should be nonzero
    And stderr should contain "required"

  # --- Data-Driven: Input Types ---

  Scenario Outline: Fill various input types
    Given an accessibility snapshot has been taken with UIDs assigned
    And the page has an input of type "<type>" with UID "s1"
    When I run "chrome-cli form fill s1 '<value>'"
    Then the exit code should be 0
    And the output JSON "value" should be "<value>"

    Examples:
      | type     | value              |
      | text     | Hello World        |
      | password | secret123          |
      | email    | user@example.com   |
      | number   | 42                 |
      | date     | 2026-01-15         |
      | tel      | 555-1234           |
      | url      | https://example.com |
