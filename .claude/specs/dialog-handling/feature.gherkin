# File: tests/features/dialog.feature
#
# Generated from: .claude/specs/dialog-handling/requirements.md
# Issue: #20

Feature: Browser Dialog Handling
  As a developer / automation engineer
  I want to detect and handle browser dialogs from the CLI
  So that my automation scripts can respond to dialogs programmatically

  Background:
    Given Chrome is running with CDP enabled
    And a page is loaded in the active tab

  # --- Happy Path ---

  Scenario: Accept an alert dialog
    Given the page has triggered an alert dialog with message "Hello"
    When I run "chrome-cli dialog handle accept"
    Then the output JSON should contain "action" equal to "accept"
    And the output JSON should contain "dialog_type" equal to "alert"
    And the output JSON should contain "message" equal to "Hello"
    And the exit code should be 0

  Scenario: Dismiss a confirm dialog
    Given the page has triggered a confirm dialog with message "Are you sure?"
    When I run "chrome-cli dialog handle dismiss"
    Then the output JSON should contain "action" equal to "dismiss"
    And the output JSON should contain "dialog_type" equal to "confirm"
    And the output JSON should contain "message" equal to "Are you sure?"
    And the exit code should be 0

  Scenario: Accept a prompt dialog with text
    Given the page has triggered a prompt dialog with message "Enter name:" and default "default"
    When I run "chrome-cli dialog handle accept --text Alice"
    Then the output JSON should contain "action" equal to "accept"
    And the output JSON should contain "dialog_type" equal to "prompt"
    And the output JSON should contain "message" equal to "Enter name:"
    And the output JSON should contain "text" equal to "Alice"
    And the exit code should be 0

  Scenario: Handle a beforeunload dialog
    Given the page has registered a beforeunload handler
    And a navigation has been triggered causing a beforeunload dialog
    When I run "chrome-cli dialog handle accept"
    Then the output JSON should contain "action" equal to "accept"
    And the output JSON should contain "dialog_type" equal to "beforeunload"
    And the exit code should be 0

  # --- Dialog Info ---

  Scenario: Query dialog info when a dialog is open
    Given the page has triggered a prompt dialog with message "Enter name:" and default "default"
    When I run "chrome-cli dialog info"
    Then the output JSON should contain "open" equal to true
    And the output JSON should contain "type" equal to "prompt"
    And the output JSON should contain "message" equal to "Enter name:"
    And the output JSON should contain "default_value" equal to "default"
    And the exit code should be 0

  Scenario: Query dialog info when no dialog is open
    Given no dialog is currently open
    When I run "chrome-cli dialog info"
    Then the output JSON should contain "open" equal to false
    And the exit code should be 0

  # --- Tab Targeting ---

  Scenario: Handle dialog with tab targeting
    Given a dialog is open on a specific tab
    When I run "chrome-cli dialog handle accept --tab {tab_id}"
    Then the dialog on that tab is accepted
    And the output JSON should contain "action" equal to "accept"
    And the exit code should be 0

  # --- Auto-Dismiss ---

  Scenario: Auto-dismiss dialogs during navigation
    Given the page will trigger an alert dialog during navigation
    When I run "chrome-cli navigate https://example.com --auto-dismiss-dialogs"
    Then the navigation completes without blocking on the dialog
    And the exit code should be 0

  # --- Error Handling ---

  Scenario: Handle dialog when no dialog is open
    Given no dialog is currently open
    When I run "chrome-cli dialog handle accept"
    Then stderr should contain a JSON error with message about no dialog being open
    And the exit code should be non-zero

  # --- Plain Text Output ---

  Scenario: Plain text output for dialog handle
    Given the page has triggered an alert dialog with message "Hello"
    When I run "chrome-cli dialog handle accept --plain"
    Then the output should contain "Accepted alert"
    And the output should contain "Hello"
    And the exit code should be 0

  Scenario: Plain text output for dialog info when open
    Given the page has triggered a confirm dialog with message "Continue?"
    When I run "chrome-cli dialog info --plain"
    Then the output should contain "confirm"
    And the output should contain "Continue?"
    And the exit code should be 0

  # --- Data-Driven: All Dialog Types ---

  Scenario Outline: Handle different dialog types
    Given the page has triggered a <type> dialog with message "<message>"
    When I run "chrome-cli dialog handle accept"
    Then the output JSON should contain "dialog_type" equal to "<type>"
    And the output JSON should contain "message" equal to "<message>"
    And the exit code should be 0

    Examples:
      | type         | message                |
      | alert        | Alert message          |
      | confirm      | Confirm this action?   |
      | prompt       | Enter a value:         |

  Scenario Outline: Accept and dismiss actions
    Given the page has triggered a confirm dialog with message "Confirm?"
    When I run "chrome-cli dialog handle <action>"
    Then the output JSON should contain "action" equal to "<action>"
    And the exit code should be 0

    Examples:
      | action  |
      | accept  |
      | dismiss |
