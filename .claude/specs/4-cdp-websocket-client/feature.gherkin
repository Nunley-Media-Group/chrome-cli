# File: tests/features/cdp-websocket-client.feature
#
# Generated from: .claude/specs/4-cdp-websocket-client/requirements.md
# Issue: #4

Feature: CDP WebSocket Client
  As a developer using chrome-cli
  I want a reliable CDP client that communicates with Chrome over WebSocket
  So that CLI commands can send DevTools Protocol messages to the browser

  Background:
    Given a mock CDP WebSocket server is running

  # --- Happy Path ---

  Scenario: Connect to Chrome CDP endpoint
    When the CDP client connects to the mock server
    Then the connection is established successfully
    And the client reports it is connected

  Scenario: Send command and receive response
    Given a connected CDP client
    When I send a "Page.navigate" command with params '{"url": "https://example.com"}'
    Then I receive a response with a matching message ID
    And the response contains a result object

  Scenario: Concurrent command correlation
    Given a connected CDP client
    When I send 10 commands concurrently
    Then each command receives its own unique response
    And no responses are mismatched

  Scenario: Receive CDP events
    Given a connected CDP client subscribed to "Page.loadEventFired"
    When the server emits a "Page.loadEventFired" event with params '{"timestamp": 123.456}'
    Then the event is delivered to the subscriber
    And the event method is "Page.loadEventFired"
    And the event params contain "timestamp"

  Scenario: Event subscription and unsubscription
    Given a connected CDP client subscribed to "Console.messageAdded"
    When the subscriber is dropped
    And the server emits a "Console.messageAdded" event
    Then no event is delivered

  Scenario: Session multiplexing over single WebSocket
    Given a connected CDP client
    And a CDP session "session-1" attached to target "target-1"
    And a CDP session "session-2" attached to target "target-2"
    When I send a command on session "session-1"
    And I send a command on session "session-2"
    Then the command for session "session-1" includes sessionId "session-1"
    And the command for session "session-2" includes sessionId "session-2"
    And each session receives its own response

  Scenario: Flatten session protocol support
    Given a connected CDP client with session "session-abc"
    When I send a "Runtime.evaluate" command on session "session-abc"
    Then the outgoing WebSocket message contains '"sessionId":"session-abc"'
    And the response is routed to the correct session

  # --- Timeout Handling ---

  Scenario: Connection timeout
    Given an unreachable CDP endpoint
    When the client attempts to connect with a 1-second timeout
    Then a ConnectionTimeout error is returned
    And the error is returned within 2 seconds

  Scenario: Command timeout
    Given a connected CDP client with a 1-second command timeout
    When I send a command and the server does not respond
    Then a CommandTimeout error is returned
    And other in-flight commands are not affected

  # --- Connection Lifecycle ---

  Scenario: WebSocket close handling
    Given a connected CDP client with a pending command
    When the server closes the WebSocket connection
    Then the pending command receives a ConnectionClosed error
    And the client reports it is disconnected

  Scenario: Reconnection after disconnection
    Given a connected CDP client with reconnection enabled
    When the server drops the connection
    And the server restarts
    Then the client reconnects automatically
    And the client reports it is connected
    And the client can send commands again

  Scenario: Reconnection failure after retries exhausted
    Given a connected CDP client with max 2 reconnection retries
    When the server drops the connection permanently
    Then a ReconnectFailed error is reported
    And the client reports it is disconnected

  # --- Error Handling ---

  Scenario: CDP protocol error handling
    Given a connected CDP client
    When I send a command that the server rejects with code -32000 and message "Not found"
    Then a Protocol error is returned
    And the error contains code -32000
    And the error contains message "Not found"

  Scenario: Invalid JSON handling
    Given a connected CDP client with a pending command
    When the server sends malformed JSON "this is not json{"
    Then the client does not crash
    And valid commands sent afterward still work
